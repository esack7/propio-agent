#!/bin/bash

set -e

# Resolve the directory where this script is located
PROPIO_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Check if ~/.propio directory exists
if [ ! -d "$HOME/.propio" ]; then
  echo "Error: ~/.propio/ directory not found" >&2
  echo "Please create the directory and add your providers.json configuration:" >&2
  echo "  mkdir -p ~/.propio" >&2
  echo "  # Copy or create ~/.propio/providers.json with your provider settings" >&2
  echo "See README for configuration examples." >&2
  exit 1
fi

# Check if Docker is installed
if ! command -v docker &> /dev/null; then
  echo "Error: Docker is not installed." >&2
  echo "Please install Docker from https://docs.docker.com/get-docker/" >&2
  exit 1
fi

# Check if Docker daemon is running
if ! docker info &> /dev/null; then
  echo "Error: Docker daemon is not running." >&2
  echo "Please start Docker Desktop or the Docker service." >&2
  exit 1
fi

# Check if Docker image exists
if ! docker compose -f "$PROPIO_DIR/docker-compose.yml" config &> /dev/null; then
  echo "Error: Cannot read docker-compose.yml." >&2
  exit 1
fi

if ! docker compose -f "$PROPIO_DIR/docker-compose.yml" images -q &> /dev/null; then
  echo "Error: Docker image has not been built yet." >&2
  echo "Please run: docker compose build" >&2
  exit 1
fi

# Build environment variable flags for provider credentials
ENV_FLAGS=()
for var in OPENROUTER_API_KEY AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_PROFILE AWS_DEFAULT_REGION AWS_REGION OLLAMA_HOST; do
  if [ -n "${!var}" ]; then
    ENV_FLAGS+=(-e "$var")
  fi
done

# Run agent in Docker container with dynamic volume mounts
docker compose -f "$PROPIO_DIR/docker-compose.yml" run --rm \
  "${ENV_FLAGS[@]}" \
  -v "$(pwd):/workspace" \
  -v "$HOME/.propio:/app/.propio:ro" \
  agent
